{{>admin/layouts/header}}
<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!--<div class="container">-->
<div class="container">
    <div class="page-inner">
        <!-- ìƒë‹¨ í—¤ë” -->
        <div class="d-flex align-items-left align-items-md-center flex-column flex-md-row pt-2 pb-4">
            <div>
                <h3 class="fw-bold mb-3">ëŒ€ì‹œë³´ë“œ</h3>
                <h6 class="op-7 mb-2">Jelly Mullyì˜ ê´€ë¦¬ììš© ëŒ€ì‹œë³´ë“œì…ë‹ˆë‹¤.</h6>
            </div>
        </div>
        <!-- ìƒë‹¨ ì¹´ë“œ -->
        <div class="row">
            <!-- ë°©ë¬¸ì ìˆ˜ ì¹´ë“œ -->
            <div class="col-sm-6 col-md-3">
                <div class="card card-stats card-round">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-icon">
                                <div class="icon-big text-center icon-primary bubble-shadow-small">
                                    <i class="fas fa-users"></i>
                                </div>
                            </div>
                            <div class="col col-stats ms-3 ms-sm-0">
                                <div class="numbers">
                                    <p class="card-category">ë°©ë¬¸ì ìˆ˜</p>
                                    <h4 class="card-title" id="visitor-count">ë¡œë”© ì¤‘...</h4>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- ì œë³´ì ìˆ˜ ì¹´ë“œ -->
            <div class="col-sm-6 col-md-3">
                <div class="card card-stats card-round">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-icon">
                                <div class="icon-big text-center icon-info bubble-shadow-small">
                                    <i class="fas fa-user-check"></i>
                                </div>
                            </div>
                            <div class="col col-stats ms-3 ms-sm-0">
                                <div class="numbers">
                                    <p class="card-category">ì œë³´ì ìˆ˜</p>
                                    <h4 class="card-title" id="report-count">ë¡œë”© ì¤‘...</h4>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- ê²½ë³´ ì•Œë¦¼ ìˆ˜ ì¹´ë“œ -->
            <div class="col-sm-6 col-md-3">
                <div class="card card-stats card-round">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-icon">
                                <div class="icon-big text-center icon-success bubble-shadow-small">
                                    <i class="fas fa-luggage-cart"></i>
                                </div>
                            </div>
                            <div class="col col-stats ms-3 ms-sm-0">
                                <div class="numbers">
                                    <p class="card-category">ê²½ë³´ ì•Œë¦¼ ìˆ˜</p>
                                    <h4 class="card-title" id="alert-count">0</h4>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- ì°¨íŠ¸ ì˜ì—­ -->
        <div class="column-gap-0">
            <!-- í•´íŒŒë¦¬ ê²½ë³´ í˜„í™© ì°¨íŠ¸ (Bar Chart) -->
            <div class="col-md-10">
                <div class="card card-round">
                    <div class="card-header">
                        <div class="card-head-row">
                            <div class="card-title">í•´íŒŒë¦¬ ê²½ë³´ í˜„í™©</div>
                            <div class="card-tools"></div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="chart-container" style="min-height: 375px">
                            <canvas id="statisticsChart"></canvas>
                        </div>
                        <div id="myChartLegend"></div>
                    </div>
                </div>
            </div>
            <!-- í•´íŒŒë¦¬ ëª¨ë‹ˆí„°ë§ ì£¼ê°„ë³´ê³  ìš”ì•½ ì°¨íŠ¸ ì˜ì—­ -->
            <div class="col-md-10">
                <div class="card card-round">
                    <div class="card-header">
                        <div class="card-head-row">
                            <div class="card-title">í•´íŒŒë¦¬ ëª¨ë‹ˆí„°ë§ ì£¼ê°„ë³´ê³  ìš”ì•½</div>
                            <div class="card-tools"></div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <!-- ì œë³´ ê±´ ìˆ˜ ì°¨íŠ¸, ì¢Œ -->
                            <div class="col-md-6">
                                <div class="chart-container" style="min-height: 375px;">
                                    <canvas id="reportsChart" height="375"></canvas>
                                </div>
                            </div>
                            <!-- í•´íŒŒë¦¬ ì¢…ë¥˜ë³„ ì œë³´ ë¹„ìœ¨ íŒŒì´ ì°¨íŠ¸, ìš° -->
                            <div class="col-md-6">
                                <div class="chart-container" style="min-height: 375px;">
                                    <canvas id="jellyPieChart"></canvas>
                                </div>
                            </div>
                        </div>
                        <div id="myChartLegend"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // ì„œë²„ì—ì„œ ì „ë‹¬ëœ alertsJsonê³¼ reportsJsonì„ íŒŒì‹±í•©ë‹ˆë‹¤.
    const alerts = JSON.parse('{{{alertsJson}}}');
    const reports = JSON.parse('{{{reportsJson}}}');
    // const reportData = reports.content || []; // ì¶”ê°€

    // ì˜¤ëŠ˜ ê¸°ì¤€ ì§€ë‚œ 7ì¼ì˜ ë‚ ì§œ ë¬¸ìì—´ ë°°ì—´ (YYYY-MM-DD)
    const now = new Date();
    const last7Days = [];
    for (let i = 6; i >= 0; i--) {
        const d = new Date();
        d.setDate(now.getDate() - i);
        const yyyy = d.getFullYear();
        const mm = String(d.getMonth() + 1).padStart(2, '0');
        const dd = String(d.getDate()).padStart(2, '0');
        last7Days.push(`${yyyy}-${mm}-${dd}`);
    }

    // í—¬í¼ í•¨ìˆ˜: ë‚ ì§œ ë¬¸ìì—´ì„ ISO í˜•ì‹(ì˜ˆ:"2025-02-06T14:00:00")ìœ¼ë¡œ ë³€í™˜í•˜ì—¬ Date ê°ì²´ ë°˜í™˜
    function parseDate(dateStr) {
        if (!dateStr) return new Date();
        if (dateStr.indexOf('T') !== -1) {
            return new Date(dateStr);
        }
        const parts = dateStr.split(" ");
        if (parts.length === 2) {
            if (parts[1].indexOf(":") === -1) {
                dateStr = parts[0] + "T" + parts[1] + ":00:00";
            } else {
                dateStr = parts[0] + "T" + parts[1] + ":00";
            }
        }
        return new Date(dateStr);
    }

    // ===== í•´íŒŒë¦¬ ê²½ë³´ í˜„í™© ì§‘ê³„ (Alerts) =====
    const uniqueBeachesAlerts = new Set(alerts.map(alert => alert.beach));
    const beachAlertCounts = {};
    uniqueBeachesAlerts.forEach(beach => {
        beachAlertCounts[beach] = 0;
    });
    alerts.forEach(alert => {
        // ê²½ë³´ ì•Œë¦¼ ìˆ˜ê°€ 0 ì´í•˜ì¸ í•­ëª©ì€ ì œì™¸
        if (alert.appearPred <= 0) return;
        const rawDateStr = alert.createDate || alert.time;
        const parsedDate = parseDate(rawDateStr);
        if (isNaN(parsedDate.getTime())) {
            console.error('Invalid date for alert:', alert);
            return;
        }
        const alertDateStr = parsedDate.toISOString().substring(0, 10);
        if (last7Days.includes(alertDateStr)) {
            beachAlertCounts[alert.beach]++;
        }
    });
    const alertLabels = Object.keys(beachAlertCounts);
    const alertDataValues = alertLabels.map(beach => beachAlertCounts[beach]);
    const colors = ['red', 'blue', 'green', 'orange', 'purple', 'cyan', 'magenta'];
    const alertBackgroundColors = alertLabels.map((beach, index) => colors[index % colors.length]);

    // Chart.js Bar Chart for í•´íŒŒë¦¬ ê²½ë³´ í˜„í™©
    const ctxAlerts = document.getElementById('statisticsChart').getContext('2d');
    new Chart(ctxAlerts, {
        type: 'bar',
        data: {
            labels: alertLabels,
            datasets: [{
                label: '7ì¼ ê°„ ê²½ë³´ ì•Œë¦¼ ìˆ˜',
                data: alertDataValues,
                backgroundColor: alertBackgroundColors,
                borderColor: alertBackgroundColors,
                borderWidth: 1
            }]
        },
        options: {
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: { stepSize: 1 }
                }
            },
            responsive: true,
            plugins: {
                legend: { position: 'top' },
                title: { display: true, text: 'í•´ë³€ë³„ 7ì¼ ì´ ê²½ë³´ ì•Œë¦¼ ìˆ˜' }
            }
        }
    });

    // ===== í•´íŒŒë¦¬ ëª¨ë‹ˆí„°ë§ ì£¼ê°„ë³´ê³  - í•´ë³€ë³„ ì œë³´ ê±´ ìˆ˜ ì§‘ê³„ (Reports) =====
    // ReportResponseì—ì„œëŠ” í•´ë³€ ì´ë¦„ì´ 'location'ìœ¼ë¡œ ì €ì¥ë©ë‹ˆë‹¤.
    const uniqueBeachesReports = new Set(reports.map(report => report.location));
    const beachReportCounts = {};
    uniqueBeachesReports.forEach(location => {
        beachReportCounts[location] = 0;
    });
    reports.forEach(report => {
        const rawDateStr = report.createDate || report.time;
        const parsedDate = parseDate(rawDateStr);
        if (isNaN(parsedDate.getTime())) {
            console.error('Invalid date for report:', report);
            return;
        }
        const reportDateStr = parsedDate.toISOString().substring(0, 10);
        if (last7Days.includes(reportDateStr)) {
            beachReportCounts[report.location]++;
        }
    });
    const reportLabels = Object.keys(beachReportCounts);
    const reportDataValues = reportLabels.map(location => beachReportCounts[location]);
    const reportBackgroundColors = reportLabels.map((location, index) => colors[index % colors.length]);

    // Chart.js Bar Chart for í•´ë³€ë³„ ì œë³´ ê±´ ìˆ˜
    const ctxReports = document.getElementById('reportsChart').getContext('2d');
    new Chart(ctxReports, {
        type: 'bar',
        data: {
            labels: reportLabels,
            datasets: [{
                label: '7ì¼ ê°„ ì œë³´ ê±´ ìˆ˜',
                data: reportDataValues,
                backgroundColor: reportBackgroundColors,
                borderColor: reportBackgroundColors,
                borderWidth: 1
            }]
        },
        options: {
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: { stepSize: 1 }
                }
            },
            responsive: true,
            plugins: {
                legend: { position: 'top' },
                title: { display: true, text: 'í•´ë³€ë³„ 7ì¼ ì´ ì œë³´ ê±´ ìˆ˜' }
            }
        }
    });
    // ===== í•´íŒŒë¦¬ ì¢…ë¥˜ë³„ ì œë³´ ë¹„ìœ¨ ì§‘ê³„ (Jelly Types) =====
    const jellyTypes = [
        "ë…¸ë¬´ë¼ì…ê¹ƒí•´íŒŒë¦¬", "ë³´ë¦„ë‹¬ë¬¼í•´íŒŒë¦¬", "ì»¤íŠ¼ì›ì–‘í•´íŒŒë¦¬",
        "ìœ ë ¹í•´íŒŒë¦¬", "ì‘ì€ìƒìí•´íŒŒë¦¬", "ë‘ë¹›ë³´ë¦„ë‹¬í•´íŒŒë¦¬",
        "ê¸°ìˆ˜ì‹ìš©í•´íŒŒë¦¬", "ì•¼ê´‘ì›ì–‘í•´íŒŒë¦¬", "í‘¸ë¥¸ìš°ì‚°ê´€í•´íŒŒë¦¬"
    ];
    const jellyCounts = {};
    jellyTypes.forEach(jelly => { jellyCounts[jelly] = 0; });
    reports.forEach(report => {
        const rawDateStr = report.createDate || report.time;
        const parsedDate = parseDate(rawDateStr);
        if (isNaN(parsedDate.getTime())) {
            console.error('Invalid date for report:', report);
            return;
        }
        const reportDateStr = parsedDate.toISOString().substring(0, 10);
        if (!last7Days.includes(reportDateStr)) return;
        const jelly = report.jelly;
        if (jellyCounts.hasOwnProperty(jelly)) {
            jellyCounts[jelly]++;
        }
    });
    const pieLabels = Object.keys(jellyCounts);
    const pieDataValues = pieLabels.map(jelly => jellyCounts[jelly]);
    const pieColors = ['#FF6384', '#36A2EB', '#FFCE56', '#8A2BE2', '#FF7F50', '#00FA9A', '#FFD700', '#00CED1', '#FF69B4'];

    // Chart.js Pie Chart for í•´íŒŒë¦¬ ì¢…ë¥˜ë³„ ì œë³´ ë¹„ìœ¨
    const ctxPie = document.getElementById('jellyPieChart').getContext('2d');
    new Chart(ctxPie, {
        type: 'pie',
        data: {
            labels: pieLabels,
            datasets: [{
                data: pieDataValues,
                backgroundColor: pieColors,
                borderColor: pieColors,
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    display: 'true',
                    position: 'right',
                    align: 'end',
                    labels: {
                        boxWidth: 10,
                        generateLabels: function (chart) {
                            const data = chart.data.datasets[0].data;
                            const total = data.reduce((acc, cur) => acc + cur, 0);
                            return chart.data.labels.map((label, i) => {
                                const value = data[i];
                                const percentage = total ? ((value / total) * 100).toFixed(1) : 0;
                                return {
                                    text: label + ' (' + percentage + '%)',
                                    fillStyle: chart.data.datasets[0].backgroundColor[i],
                                    strokeStyle: chart.data.datasets[0].borderColor[i],
                                    lineWidth: 1,
                                    hidden: isNaN(data[i]) || chart.getDatasetMeta(0).data[i].hidden,
                                    index: i
                                };
                            });
                        },
                        title: {display: true, text: 'í•´íŒŒë¦¬ ì¢…ë¥˜ë³„ ì œë³´ ë¹„ìœ¨ (7ì¼ê°„)'}
                    }
                }
            }
        }
    });
</script>

<script>
    var backend_url = "{{backend_addr}}"; // ë°±ì—”ë“œ ì£¼ì†Œë¥¼ ê°€ì ¸ì™€ì„œ ì‚¬ìš©

    function loadDashboardData() {
        // ë°©ë¬¸ì ìˆ˜ ê°€ì ¸ì˜¤ê¸°
        fetch(backend_url + "/visitor/count")
                .then(response => response.json())
                .then(count => {
                    document.getElementById("visitor-count").innerText = count.toLocaleString();
                })
                .catch(error => {
                    console.error("ë°©ë¬¸ì ìˆ˜ ì¡°íšŒ ì‹¤íŒ¨:", error);
                    document.getElementById("visitor-count").innerText = "ì¡°íšŒ ì‹¤íŒ¨";
                });

        // ë‹¹ì¼ ì œë³´ ê°œìˆ˜ ê°€ì ¸ì˜¤ê¸°
        fetch(backend_url + "/api/board/count/today")
                .then(response => response.json())
                .then(data => {
                    document.getElementById("report-count").innerText = data.result.toLocaleString();  // âœ… result ê°’ë§Œ ì¶œë ¥!
                })
                .catch(error => {
                    document.getElementById("report-count").innerText = "ì¡°íšŒ ì‹¤íŒ¨";
                });

        // ë‹¹ì¼ ê²½ë³´ ì•Œë¦¼ ê°œìˆ˜ ê°€ì ¸ì˜¤ê¸°
        fetch(backend_url + "/api/alert/count/today")
                .then(response => response.json())
                .then(data => {
                    document.getElementById("alert-count").innerText = data.result.toLocaleString();
                })
                .catch(error => {
                    console.error("ğŸš¨ ê²½ë³´ ì•Œë¦¼ ìˆ˜ ì¡°íšŒ ì‹¤íŒ¨:", error);
                    document.getElementById("alert-count").innerText = "ì¡°íšŒ ì‹¤íŒ¨";
                });


    }

    document.addEventListener("DOMContentLoaded", loadDashboardData);
</script>



{{>admin/layouts/footer}}
